rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to validate groupId is present and not null
    function hasValidGroupId() {
      return request.resource.data.groupId is string && 
             request.resource.data.groupId != null && 
             request.resource.data.groupId.size() > 0;
    }
    
    // Helper function to check if user belongs to the group
    function belongsToGroup(groupId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/groups/$(groupId)/members/$(request.auth.uid));
    }

    // Denominations collection - must have valid groupId
    match /denominations/{denominationId} {
      allow read: if isAuthenticated() && 
                     resource.data.groupId is string &&
                     belongsToGroup(resource.data.groupId);
      
      allow create: if isAuthenticated() && 
                       hasValidGroupId() &&
                       belongsToGroup(request.resource.data.groupId);
      
      allow update: if isAuthenticated() && 
                       hasValidGroupId() &&
                       resource.data.groupId == request.resource.data.groupId &&
                       belongsToGroup(resource.data.groupId);
      
      allow delete: if isAuthenticated() && 
                       belongsToGroup(resource.data.groupId);
    }

    // Transactions collection - must have valid groupId
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && 
                     resource.data.groupId is string &&
                     belongsToGroup(resource.data.groupId);
      
      allow create: if isAuthenticated() && 
                       hasValidGroupId() &&
                       belongsToGroup(request.resource.data.groupId);
      
      allow update: if isAuthenticated() && 
                       hasValidGroupId() &&
                       resource.data.groupId == request.resource.data.groupId &&
                       belongsToGroup(resource.data.groupId);
      
      allow delete: if isAuthenticated() && 
                       belongsToGroup(resource.data.groupId);
    }

    // Inventory collection - document ID is the groupId
    match /inventory/{groupId} {
      allow read: if isAuthenticated() && belongsToGroup(groupId);
      
      allow write: if isAuthenticated() && 
                      belongsToGroup(groupId) &&
                      request.resource.data.groupId == groupId &&
                      request.resource.data.groupId is string &&
                      request.resource.data.groupId.size() > 0;
    }

    // Groups collection
    match /groups/{groupId} {
      allow read: if isAuthenticated() && belongsToGroup(groupId);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && belongsToGroup(groupId);
      
      match /members/{userId} {
        allow read: if isAuthenticated() && belongsToGroup(groupId);
        allow write: if isAuthenticated() && belongsToGroup(groupId);
      }
    }

    // Family members (users) collection
    match /family_members/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Fallback - deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}